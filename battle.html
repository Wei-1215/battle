import React, { useState, useEffect, useRef } from 'react';
import { Trophy, Clock, Flame, AlertCircle, CheckCircle2, XCircle, Users, ArrowRight, BookOpen, ChevronDown, ChevronUp, ArrowUpCircle, TrendingUp } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  serverTimestamp,
  query,
  limit,
  where,
  updateDoc,
  doc
} from 'firebase/firestore';

// --- Configuration & Questions ---

// Questions based on Kang Hsuan Grade 5 Social Studies Units 3 & 4
// Concepts: Prehistory (Iron/Stone ages), Indigenous, Dutch/Spanish (Forts, Trade), Zheng (Policies, Education)
const MASTER_QUESTIONS = [
  // --- åŸæœ‰é¸æ“‡é¡Œ (1-20) ---
  {
    id: 1,
    category: "å²å‰æ™‚ä»£",
    question: "æˆ‘å€‘ç„¡æ³•å¾ä¸‹åˆ—å“ªä¸€å€‹é¸é …ä¾†æ¨æ¸¬è‡ºç£å²å‰æ–‡åŒ–äººå€‘çš„ç”Ÿæ´»æ–¹å¼ï¼Œï¼Ÿ",
    options: ["å™¨ç‰©", "å»ºç¯‰", "æ–‡å­—", "å·¥å…·çš„ä½¿ç”¨æ–¹å¼"],
    answer: "æ–‡å­—",
    explanation: "è‡ºç£çš„å²å‰æ™‚ä»£æŒ‡çš„æ˜¯å°šæœªå‡ºç¾ã€ä¹Ÿæœªä½¿ç”¨æ–‡å­—è¨˜éŒ„çš„æ™‚æœŸï¼Œå› æ­¤ç•¶æ™‚çš„äººå€‘æ²’æœ‰ç•™ä¸‹æ–‡å­—è³‡æ–™ï¼Œå¾Œäººç„¡æ³•é€éæ–‡å­—ä¾†äº†è§£å…¶ç”Ÿæ´»ç‹€æ³ã€‚"
  },
  {
    id: 2,
    category: "è·è¥¿æ™‚æœŸ",
    question: "è·è˜­äººçµ±æ²»è‡ºç£æœŸé–“ï¼Œä¸»è¦å°‡å“ªå…©é …å•†å“å‡ºå£åˆ°æ—¥æœ¬å’Œä¸­åœ‹ï¼Œç²å–å·¨é¡åˆ©ç›Šï¼Ÿ",
    options: ["ç¨»ç±³ã€èŒ¶è‘‰", "é¹¿çš®ã€è”—ç³–", "æ¨Ÿè…¦ã€ç¡«ç£º", "é»ƒé‡‘ã€é¦™æ–™"],
    answer: "é¹¿çš®ã€è”—ç³–",
    explanation: "è·è˜­äººå°‡è‡ºç£ç”¢çš„ã€Œè”—ç³–ã€é‹å¾€æ—¥æœ¬ã€æ³¢æ–¯ï¼Œå°‡ã€Œé¹¿çš®ã€é‹å¾€æ—¥æœ¬ï¼Œä»¥æ­¤ç²å–é«˜é¡åˆ©æ½¤ã€‚"
  },
  {
    id: 3,
    category: "æ­·å²æ™‚åº",
    question: "ã€æ™‚é–“æ’åºã€‘è«‹ä¾ç…§ç™¼ç”Ÿçš„å…ˆå¾Œé †åºï¼Œé¸å‡ºæ­£ç¢ºçš„æ­·å²ç™¼å±•æµç¨‹ï¼š\n(ç”²) éƒ­æ‡·ä¸€äº‹ä»¶çˆ†ç™¼\n(ä¹™) è·è˜­äººç™»é™¸è‡ºç£\n(ä¸™) è·è˜­äººå»ºç«‹æ™®ç¾…æ°‘é®åŸï¼ŒåŠ å¼·é˜²ç¦¦\n(ä¸) è·è˜­äººæ¬ºå£“æ¼¢äººä¸¦èª²é‡ç¨…\n(æˆŠ) è·è˜­äººæ‹›å‹Ÿæ¼¢äººä¾†è‡ºé–‹å¢¾",
    options: [
  "ä¹™ â†’ æˆŠ â†’ ä¸ â†’ ç”² â†’ ä¸™",
  "ä¹™ â†’ ä¸ â†’ æˆŠ â†’ ç”² â†’ ä¸™",
  "æˆŠ â†’ ä¹™ â†’ ä¸ â†’ ç”² â†’ ä¸™",
  "ä¹™ â†’ æˆŠ â†’ ç”² â†’ ä¸ â†’ ä¸™"],
  answer: "ä¹™ â†’ æˆŠ â†’ ä¸ â†’ ç”² â†’ ä¸™",
  explanation: "æ­£ç¢ºé †åºç‚ºï¼š(ä¹™)è·è˜­äººç™»é™¸è‡ºç£å¾Œå»ºç«‹çµ±æ²» â†’ (æˆŠ)ç‚ºç™¼å±•ç¶“æ¿Ÿèˆ‡è¾²æ¥­ï¼Œæ‹›å‹Ÿå¤§é‡æ¼¢äººä¾†è‡ºé–‹å¢¾ â†’ (ä¸)éš¨è‘—çµ±æ²»æ·±åŒ–ï¼Œå°æ¼¢äººèª²ä»¥é‡ç¨…ä¸¦å¼·è¿«å‹å½¹ï¼Œå¼•ç™¼ä¸æ»¿ â†’ (ç”²)ä¸æ»¿æƒ…ç·’ç´¯ç©ï¼Œçˆ†ç™¼éƒ­æ‡·ä¸€äº‹ä»¶ â†’ (ä¸™)äº‹ä»¶å¾Œï¼Œè·è˜­äººç‚ºé˜²æ­¢å†åº¦åæŠ—ï¼Œå»ºç«‹æ™®ç¾…æ°‘é®åŸä»¥æ“´å¤§é˜²ç¦¦ã€‚"
  },
  {
    id: 4,
    category: "è·è¥¿æ™‚æœŸ",
    question: "è¥¿ç­ç‰™äººæ›¾ç¶“åœ¨è‡ºç£åŒ—éƒ¨çš„æ·¡æ°´å»ºç«‹å“ªä¸€åº§åŸå ¡ï¼Œä½œç‚ºç™¼å±•è²¿æ˜“èˆ‡å‚³æ•™çš„æ“šé»ï¼Ÿ",
    options: ["ç†±è˜­é®åŸ", "æ™®ç¾…æ°‘é®åŸ", "è–å¤šæ˜å“¥åŸ", "è–è–©çˆ¾ç“¦å¤šåŸ"],
    answer: "è–å¤šæ˜å“¥åŸ",
    explanation: "è¥¿ç­ç‰™äººåœ¨æ·¡æ°´æ²³å£èˆˆå»ºã€Œè–å¤šæ˜å“¥åŸã€ã€‚è–è–©çˆ¾ç“¦å¤šåŸå‰‡æ˜¯ä½æ–¼åŸºéš†å’Œå¹³å³¶ã€‚"
  },
  {
    id: 5,
    category: "å²å‰æ™‚ä»£",
    question: "èˆŠçŸ³å™¨æ™‚ä»£çš„é•·æ¿±æ–‡åŒ–äººï¼Œæœ€ä¸»è¦çš„ç”Ÿæ´»æ–¹å¼æ˜¯ä»€éº¼ï¼Ÿ",
    options: ["ç¨®æ¤æ°´ç¨»", "ä½¿ç”¨é™¶å™¨çƒ¹ç…®", "æ¡é›†èˆ‡æ¼çµ", "ç…‰è£½é‡‘å±¬"],
    answer: "æ¡é›†èˆ‡æ¼çµ",
    explanation: "èˆŠçŸ³å™¨æ™‚ä»£äººé¡å°šæœªç™¼æ˜è¾²æ¥­èˆ‡é™¶å™¨ï¼Œä¸»è¦ä¾é æ¡é›†é‡æœã€æŒ–æ˜æ¤ç‰©æ ¹è–èˆ‡æ•æ‰é­šé¡é‡ç¸ç¶­ç”Ÿã€‚"
  },
  {
    id: 6,
    category: "é„­æ°æ™‚æœŸ",
    question: "é„­æ°æ”¿æ¬Šç‚ºäº†è§£æ±ºè»éšŠç³§é£Ÿä¸è¶³çš„å•é¡Œï¼Œå¯¦æ–½äº†ä»€éº¼æ”¿ç­–ï¼Œè®“å£«å…µå¹³æ™‚è€•ç”°ã€æˆ°æ™‚æ‰“ä»—ï¼Ÿ",
    options: ["å¯“å…µæ–¼è¾²(å±¯ç”°)", "å°ˆè³£åˆ¶åº¦", "é–åœ‹æ”¿ç­–", "å…¬åœ°æ”¾é ˜"],
    answer: "å¯“å…µæ–¼è¾²(å±¯ç”°)",
    explanation: "ã€Œå¯“å…µæ–¼è¾²ã€å³å±¯ç”°æ”¿ç­–ï¼Œè®“è»éšŠåœ¨é§ç´®åœ°é–‹å¢¾è’åœ°ç¨®ç”°ï¼Œæ—¢è§£æ±ºç³§é£Ÿå•é¡Œï¼Œä¹Ÿä¸è’å»¢æˆ°å‚™ã€‚"
  },
  {
    id: 7,
    category: "è·è¥¿æ™‚æœŸ",
    question: "ç‚ºäº†å‘åŸä½æ°‘å‚³æ•™ï¼Œè·è˜­å‚³æ•™å£«ä½¿ç”¨ç¾…é¦¬æ‹¼éŸ³æ‹¼å¯«åŸä½æ°‘èªè¨€ï¼Œç•™ä¸‹äº†ä»€éº¼é‡è¦æ–‡ç»ï¼Ÿ",
    options: ["ç•ªä»”å¥‘", "æ–°æ¸¯æ–‡æ›¸", "å²¸è£¡å¤§ç¤¾æ–‡æ›¸", "æ·¡æ°´å»³å¿—"],
    answer: "æ–°æ¸¯æ–‡æ›¸",
    explanation: "è·è˜­å‚³æ•™å£«ç‚ºäº†å‚³æ•™ï¼Œç”¨ç¾…é¦¬å­—æ¯æ‹¼å¯«è¥¿æ‹‰é›…æ—çš„èªè¨€ã€‚é€™äº›æ–‡å­—å¾Œä¾†è¢«ç”¨æ–¼èˆ‡æ¼¢äººç°½è¨‚åœŸåœ°å¥‘ç´„ï¼Œä¿—ç¨±ã€Œæ–°æ¸¯æ–‡æ›¸ã€æˆ–ã€Œç•ªä»”å¥‘ã€ã€‚"
  },
{
  id: 8,
  category: "åŸä½æ°‘æ—",
  question: "é—œæ–¼åŸä½æ°‘æ—çš„ç”Ÿæ´»æ–‡åŒ–ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…éŒ¯èª¤ï¼Ÿ",
  options: [
    "è¨±å¤šåŸä½æ°‘æ—æœƒä¾ç…§å­£ç¯€èª¿æ•´ç‹©çµæ´»å‹•ï¼Œå±•ç¾å°è‡ªç„¶çš„å°Šé‡",
    "åŸä½æ°‘æ—æ˜¯å²å‰æ™‚ä»£åœ¨å°ç£å³¶ä¸Šç”Ÿæ´»çš„äººä¹‹ä¸€",
    "è³½å¾·å…‹æ—è¦å®šæ—äººåœ¨å¤ã€ç§‹å…©å­£ç¦æ­¢ç‹©çµ",
    "åŸä½æ°‘æ—æ—¥åœ¨8æœˆ1æ—¥"
  ],
  answer: "è³½å¾·å…‹æ—è¦å®šæ—äººåœ¨å¤ã€ç§‹å…©å­£ç¦æ­¢ç‹©çµ",
  explanation: "è³½å¾·å…‹æ—çš„ç¦çµåˆ¶åº¦ä¸»è¦æ˜¯åœ¨æ˜¥ã€å¤å­£å¯¦æ–½ï¼Œç›®çš„æ˜¯è®“å‹•ç‰©èƒ½åœ¨ç¹æ®–å­£ç¯€å®‰å¿ƒç¹è¡å¾Œä»£ï¼›ä¸¦éå¤ã€ç§‹å…©å­£ï¼Œå› æ­¤è©²æ•˜è¿°éŒ¯èª¤ã€‚"
  },
  {
    id: 9,
    category: "å²å‰æ™‚ä»£",
    question: "æ–°çŸ³å™¨æ™‚ä»£èˆ‡èˆŠçŸ³å™¨æ™‚ä»£æœ€å¤§çš„å·®åˆ¥ï¼Œé™¤äº†ç£¨è£½çŸ³å™¨å¤–ï¼Œé‚„åŒ…å«äº†å“ªé …æŠ€è¡“çš„ç™¼å±•ï¼Ÿ",
    options: ["ç‡’è£½é™¶å™¨èˆ‡è¾²æ¥­", "ä½¿ç”¨éµå™¨", "ä½¿ç”¨ç«", "ç™¼æ˜æ–‡å­—"],
    answer: "ç‡’è£½é™¶å™¨èˆ‡è¾²æ¥­",
    explanation: "æ–°çŸ³å™¨æ™‚ä»£çš„ä¸‰å¤§ç‰¹å¾µï¼šç£¨è£½çŸ³å™¨ã€ç‡’è£½é™¶å™¨ã€å‡ºç¾è¾²æ¥­ï¼ˆé–‹å§‹å®šå±…ï¼‰ã€‚"
  },
  {
    id: 10,
    category: "é„­æ°æ™‚æœŸ",
    question: "é„­æ°æ”¿æ¬Šæ™‚æœŸï¼Œç‚ºäº†çªç ´æ¸…æœçš„æµ·ç¦å°é–ï¼Œç©æ¥µèˆ‡å“ªå…©å€‹åœ‹å®¶é€²è¡Œè²¿æ˜“ï¼Ÿ",
    options: ["ç¾åœ‹ã€æ³•åœ‹", "ä¸­åœ‹ã€æ—¥æœ¬", "è‘¡è„ç‰™ã€è¥¿ç­ç‰™", "è·è˜­ã€è²å¾‹è³“"],
    answer: "ä¸­åœ‹ã€æ—¥æœ¬",
    explanation: "é„­æ°æ”¿æ¬Šä¸€æ–¹é¢èˆ‡æ—¥æœ¬è²¿æ˜“ï¼Œå¦ä¸€æ–¹é¢é€éèµ°ç§æ–¹å¼èˆ‡ä¸­åœ‹å¤§é™¸æ²¿æµ·é€²è¡Œè²¿æ˜“ï¼Œä»¥ç²å–ç‰©è³‡ã€‚"
  },
  {
    id: 11,
    category: "å²å‰æ™‚ä»£",
    question: "ä¸‹åˆ—å“ªä¸€é …å™¨ç‰©ä¸å¯èƒ½å‡ºç¾åœ¨æ–°çŸ³å™¨æ™‚ä»£ï¼Ÿ",
    options: ["è²é¡", "ç¸éª¨", "å³¶å¤–çš„éŒ¢å¹£", "ç»ç’ƒæ‰‹éŠ"],
    answer: "ç»ç’ƒæ‰‹éŠ",
    explanation: "æ–°çŸ³å™¨æ™‚ä»£çš„äººé¡å°šæœªæŒæ¡ç»ç’ƒè£½ä½œæŠ€è¡“ï¼Œé‡‘å±¬å™¨æ™‚ä»£æ™šæœŸæ™‚è¼ƒæœ‰æ©Ÿæœƒé€éäº¤æ˜“å–å¾—ç»ç’ƒè£½å“ã€‚"
  },
  {
    id: 12,
    category: "å²å‰æ™‚ä»£",
    question: "ç¾ä»Šå…«ä»™æ´è€ƒå¤éºå€ä½æ–¼æµ·æ‹”è¼ƒé«˜è™•ä¸”ä¸æ˜“å–å¾—æ°´æºï¼Œæœ€å¯èƒ½çš„åŸå› æ˜¯ä»€éº¼ï¼Ÿ",
    options: ["æµ·æ°´ä¾µè•ä½œç”¨", "æ¿å¡Šæ¨æ“ åœ°æ®¼ä¸Šå‡", "èº²é¿çŒ›ç¸", "æ°£å€™è®Šé·"],
    answer: "æ¿å¡Šæ¨æ“ åœ°æ®¼ä¸Šå‡",
    explanation: "é€™æ˜¯å› ç‚ºåœ°æ®¼è®Šå‹•ï¼ˆæ¿å¡Šæ“ å£“ï¼‰é€ æˆé™¸åœ°æŠ¬å‡ï¼Œä½¿å¾—åŸæœ¬åœ¨æµ·é‚Šçš„æ´ç©´ç¾åœ¨ä½æ–¼é«˜è™•ã€‚"
  },
  {
    id: 13,
    category: "å²å‰æ™‚ä»£",
    question: "å‘å—æ–‡åŒ–é™¤äº†æœ‰çŸ³æ¿æ£ºå¤–ï¼Œé‚„å‡ºåœŸäº†å“ªä¸€ç¨®ç²¾ç¾çš„ç‰å™¨ï¼Œé¡¯ç¤ºç•¶æ™‚é«˜è¶…çš„å·¥è—æŠ€è¡“ï¼Ÿ",
    options: ["äººç¸å½¢ç‰ç¦", "ç»ç’ƒç ", "ç…‰éµçˆ", "è¾²ç”°"],
    answer: "äººç¸å½¢ç‰ç¦",
    explanation: "äººç¸å½¢ç‰ç¦æ˜¯å‘å—æ–‡åŒ–æœ€å…·ä»£è¡¨æ€§çš„ç‰å™¨ï¼Œé¡¯ç¤ºç•¶æ™‚å·²æœ‰ç²¾æ¹›çš„ç‰å™¨åŠ å·¥æŠ€è¡“ã€‚"
  },
  {
    id: 14,
    category: "è·è¥¿æ™‚æœŸ",
    question: "è¥¿ç­ç‰™äººé™¤äº†åœ¨æ·¡æ°´å»ºåŸå¤–ï¼Œé‚„åœ¨åŸºéš†å’Œå¹³å³¶å»ºç«‹äº†å“ªä¸€åº§åŸå ¡ï¼Ÿ",
    options: ["è–è–©çˆ¾ç“¦å¤šåŸ", "ç†±è˜­é®åŸ", "æ™®ç¾…æ°‘é®åŸ", "å„„è¼‰é‡‘åŸ"],
    answer: "è–è–©çˆ¾ç“¦å¤šåŸ",
    explanation: "è¥¿ç­ç‰™äººä½”é ˜åŒ—è‡ºç£å¾Œï¼Œé¦–å…ˆåœ¨åŸºéš†ç¤¾å¯®å³¶ï¼ˆä»Šå’Œå¹³å³¶ï¼‰å»ºç«‹äº†è–è–©çˆ¾ç“¦å¤šåŸã€‚"
  },
  {
    id: 15,
    category: "å²å‰æ™‚ä»£",
    question: "è‡ºç£å²å‰æ™‚ä»£çš„äººç¾¤äº¤æµå¤šä»¥é„°è¿‘åœ°å€ç‚ºä¸»ï¼Œè¼ƒå°‘é€²è¡Œé•·è·é›¢çš„è·¨æµ·å¾€ä¾†ï¼Œæœ€ä¸»è¦çš„åŸå› æ˜¯ä»€éº¼ï¼Ÿ",
    options: ["ä¸åŒæ—ç¾¤æ–‡åŒ–å·®ç•°éå¤§", "ç¼ºä¹ç©©å®šçš„æ”¿æ²»çµ„ç¹”", "èˆªæµ·èˆ‡é€ èˆ¹æŠ€è¡“å°šæœªæˆç†Ÿ", "å„åœ°ç”Ÿæ´»ç¿’æ…£ä¸åŒ"],
    answer: "èˆªæµ·èˆ‡é€ èˆ¹æŠ€è¡“å°šæœªæˆç†Ÿ",
    explanation: "å²å‰æ™‚ä»£å°šæœªç™¼å±•æˆç†Ÿçš„èˆªæµ·èˆ‡é€ èˆ¹æŠ€è¡“ï¼Œä½¿äººå€‘é›£ä»¥é€²è¡Œé è·é›¢çš„è·¨æµ·äº¤æµï¼Œå› æ­¤å¤šä¾·é™æ–¼å€åŸŸæ€§äº¤æµã€‚"
  },
  {
  id: 16,
  category: "æ­·å²èˆ‡ç”Ÿæ´»",
  question: "å°å®‰åœ¨é–±è®€åœ‹éš›æ–°èæ™‚ï¼Œç™¼ç¾å„åœ‹å¸¸ç”¨ã€Œ2025 å¹´ï¼ˆè¥¿å…ƒï¼‰ã€ä¾†æ¨™ç¤ºå¹´ä»½ã€‚è€å¸«èªªï¼Œé€™ç¨®ç´€å¹´æ–¹å¼æºè‡ªæŸä¸€å®—æ•™æ–‡åŒ–ï¼Œæ˜¯ä»¥ä¸€ä½é‡è¦å®—æ•™äººç‰©çš„å‡ºç”Ÿä½œç‚ºç´€å…ƒçš„èµ·é»ã€‚è«‹å•ï¼Œé€™ä½å®—æ•™äººç‰©æ˜¯èª°ï¼Ÿ",
  options: ["è§€éŸ³è©è–©", "è€¶ç©Œ", "ç©†ç½•é»˜å¾·", "æ¿•å©†"],
  answer: "è€¶ç©Œ",
    explanation: "è¥¿å…ƒç´€å¹´ï¼ˆA.D.ï¼‰æºè‡ªåŸºç£æ•™æ–‡åŒ–ï¼Œæ˜¯ä»¥è€¶ç©Œèª•ç”Ÿçš„é‚£ä¸€å¹´ä½œç‚ºç´€å…ƒçš„é–‹å§‹ã€‚"
  },
  {
    id: 17,
    category: "å²å‰æ™‚ä»£",
    question: "ä¸‹åˆ—å“ªä¸€é …å™¨ç‰©å¯èƒ½å‡ºç¾åœ¨èˆŠçŸ³å™¨æ™‚ä»£",
    options: ["çŸ³å™¨", "è¾²ç”°", "é™¶ç½", "é«˜æ¶å±‹"],
    answer: "çŸ³å™¨",
    explanation: "èˆŠçŸ³å™¨æ™‚ä»£çš„äººé¡ä»¥æ¡é›†ã€ç‹©çµç‚ºä¸»è¦ç”Ÿæ´»æ–¹å¼ï¼Œå°šæœªç™¼å±•è¾²æ¥­èˆ‡å®šå±…ç”Ÿæ´»ï¼Œå…¶æœ€å…·ä»£è¡¨æ€§çš„å™¨ç‰©æ˜¯ä»¥æ‰“è£½æ–¹å¼è£½ä½œçš„çŸ³å™¨ï¼Œç”¨ä¾†åˆ‡å‰²ã€æ•²æ“Šæˆ–ç‹©çµã€‚è¾²ç”°ã€é™¶ç½ç‚ºæ–°çŸ³å™¨æ™‚ä»£çš„ç‰¹å¾µï¼Œé«˜æ¶å±‹æ˜¯é‡‘å±¬å™¨æ™‚ä»£çš„ç‰¹å¾µ"
  },
  {
    id: 18,
    category: "è·è¥¿æ™‚æœŸ",
    question: "è·è˜­äººåœ¨ä»Šå¤©çš„è‡ºå—å¸‚èµ¤å´æ¨“ä¸€å¸¶å»ºç«‹äº†å“ªä¸€åº§åŸï¼Œä½œç‚ºå•†æ¥­èˆ‡è¡Œæ”¿ä¸­å¿ƒï¼Ÿ",
    options: ["æ™®ç¾…æ°‘é®åŸ", "ç†±è˜­é®åŸ", "è–å¤šæ˜å“¥åŸ", "è–è–©çˆ¾ç“¦å¤šåŸ"],
    answer: "æ™®ç¾…æ°‘é®åŸ",
    explanation: "è·è˜­äººåœ¨èµ¤å´ï¼ˆä»Šè‡ºå—å¸‚ä¸­è¥¿å€ï¼‰å»ºç«‹æ™®ç¾…æ°‘é®åŸï¼Œä½œç‚ºå•†æ¥­èˆ‡è¡Œæ”¿ä¸­å¿ƒï¼›ç†±è˜­é®åŸå‰‡ç‚ºè»äº‹èˆ‡è²¿æ˜“ä¸­æ¨ã€‚"
  },
  {
    id: 19,
    category: "æ­·å²æ™‚åº",
    question: "ã€æ™‚é–“æ’åºã€‘é—œæ–¼å¤–ä¾†æ”¿æ¬Šåœ¨è‡ºç£çš„é€²å‡ºï¼Œä¸‹åˆ—äº‹ä»¶è«‹ä¾ç…§ç™¼ç”Ÿçš„å…ˆå¾Œé †åºæ’åˆ—ï¼š\n(ç”²) é„­æ°æ”¿æ¬Šæ“Šæ•—è·è˜­äººï¼Œå–å¾—è‡ºç£çµ±æ²»æ¬Š\n(ä¹™) è·è˜­äººä¾†åˆ°è‡ºç£å—éƒ¨å»ºç«‹æ“šé»\n(ä¸™) è·è˜­äººå‡ºå…µé©…é€è¥¿ç­ç‰™äºº\n(ä¸) è¥¿ç­ç‰™äººå é ˜è‡ºç£åŒ—éƒ¨",
    options: [
    "ä¹™ â†’ ä¸ â†’ ä¸™ â†’ ç”²",
    "ä¸ â†’ ä¹™ â†’ ä¸™ â†’ ç”²",
    "ä¹™ â†’ ä¸™ â†’ ä¸ â†’ ç”²",
    "ä¸ â†’ ä¸™ â†’ ä¹™ â†’ ç”²"
  ],
  answer: "ä¹™ â†’ ä¸ â†’ ä¸™ â†’ ç”²",
  explanation: "æ­£ç¢ºé †åºç‚ºï¼š(ä¹™)è·è˜­äººé¦–å…ˆä¾†åˆ°è‡ºç£å—éƒ¨å»ºç«‹æ“šé» â†’ (ä¸)è¥¿ç­ç‰™äººæ¥è‘—å é ˜è‡ºç£åŒ—éƒ¨ â†’ (ä¸™)è·è˜­äººå‡ºå…µé©…é€è¥¿ç­ç‰™äººï¼Œçµ±ä¸€æ§åˆ¶è‡ºç£ â†’ (ç”²)æœ€å¾Œé„­æ°æ”¿æ¬Šæ“Šæ•—è·è˜­äººï¼ŒçµæŸè·è˜­åœ¨è‡ºçµ±æ²»ã€‚"
  },
  {
    id: 20,
    category: "åŸä½æ°‘æ—",
    question: "æ—©æœŸå±…ä½åœ¨è‡ºç£è¥¿éƒ¨å¹³åŸï¼Œè¼ƒæ—©èˆ‡æ¼¢äººæ¥è§¸ä¸¦é€šå©šï¼Œç”Ÿæ´»æ–¹å¼å—æ¼¢äººå½±éŸ¿è¼ƒæ·±çš„æ˜¯å“ªä¸€ç¾¤äººï¼Ÿ",
    options: ["å¹³åŸ”æ—ç¾¤", "é«˜å±±æ—ç¾¤", "å®¢å®¶äºº", "æ–°ä½æ°‘"],
    answer: "å¹³åŸ”æ—ç¾¤",
    explanation: "å¹³åŸ”æ—ç¾¤ä¸»è¦åˆ†å¸ƒæ–¼è¥¿éƒ¨å¹³åŸèˆ‡ä¸˜é™µï¼Œå› åœ°ç†ä½ç½®é—œä¿‚ï¼Œæœ€æ—©èˆ‡æ¼¢äººæ¥è§¸ï¼Œæ–‡åŒ–èåˆè¼ƒæ·±ã€‚"
  },

  // --- æ–°å¢ï¼šæ˜¯éé¡Œ (21-30) ---
  {
    id: 21,
    question: "é„­æ°æ”¿æ¬Šæ™‚æœŸï¼Œé™³æ°¸è¯æ¨å‹•æ–‡æ•™æ”¿ç­–ï¼Œé‡è¦–æ•™è‚²èˆ‡å€«ç†æ•™åŒ–ï¼Œå…¶æ–½æ”¿ç†å¿µä¸»è¦å—åˆ°å„’å®¶æ€æƒ³çš„å½±éŸ¿ã€‚",
    options: ["æ­£ç¢º", "éŒ¯èª¤"],
    answer: "æ­£ç¢º",
    explanation: "é™³æ°¸è¯èˆˆå»ºå­”å»Ÿã€è¨­ç«‹å­¸æ ¡ã€å»ºç«‹è€ƒè©¦åˆ¶åº¦å‚³éæ¼¢äººçš„å„’å®¶æ€æƒ³ã€‚"
  },
  {
    id: 22,
    category: "åŸä½æ°‘æ—",
    question: "ã€æ˜¯éé¡Œã€‘è‡ºç£çš„åŸä½æ°‘æ—å› ç‚ºå±…ä½çš„åœ°ç†ä½ç½®ä¸åŒï¼Œå„è‡ªç™¼å±•å‡ºç¨ç‰¹çš„æ–‡åŒ–èˆ‡ç”Ÿæ´»æ–¹å¼ã€‚",
    options: ["O (æ­£ç¢º)", "X (éŒ¯èª¤)"],
    answer: "O (æ­£ç¢º)",
    explanation: "è‡ºç£åœ°ç†ç’°å¢ƒå¤šæ¨£ï¼Œå±…ä½åœ¨ä¸åŒåœ°å€ï¼ˆå¦‚é«˜å±±ã€å¹³åŸã€é›¢å³¶ï¼‰çš„åŸä½æ°‘æ—ï¼Œç‚ºäº†é©æ‡‰ç’°å¢ƒè€Œç™¼å±•å‡ºä¸åŒçš„æ–‡åŒ–ã€‚"
  },
  {
    id: 23,
    category: "è·è¥¿æ™‚æœŸ",
    question: "ã€æ˜¯éé¡Œã€‘è·è˜­äººã€è¥¿ç­ç‰™äººã€é„­æ°æ”¿æ¬Šéƒ½æ›¾åœ¨å…¨è‡ºå¤§è¦æ¨¡æ‹›å‹Ÿæ¼¢äººé€²è¡Œé–‹å¢¾ã€‚",
    options: ["O (æ­£ç¢º)", "X (éŒ¯èª¤)"],
    answer: "X (éŒ¯èª¤)",
    explanation: "è¥¿ç­ç‰™äººæ²’æœ‰ã€‚"
  },
  {
    id: 24,
    category: "é„­æ°æ™‚æœŸ",
    question: "ã€æ˜¯éé¡Œã€‘è·è˜­äººã€è¥¿ç­ç‰™äººèˆ‡é„­æˆåŠŸä¾†å°å»ºç«‹æ“šé»çš„åŸå› éƒ½ä¸€æ¨£ã€‚",
    options: ["O (æ­£ç¢º)", "X (éŒ¯èª¤)"],
    answer: "X (éŒ¯èª¤)",
    explanation: "é„­æˆåŠŸæ”»è‡ºçš„ä¸»è¦ç›®çš„æ˜¯å»ºç«‹ã€Œåæ¸…å¾©æ˜ã€çš„åŸºåœ°ï¼Œå°‹æ±‚ç³§é£Ÿèˆ‡å…µæºè£œçµ¦ã€‚"
  },
  {
    id: 25,
    category: "è·è¥¿æ™‚æœŸ",
    question: "ã€æ˜¯éé¡Œã€‘è·è˜­äººåŸå…ˆåœ¨è‡ºç£å—éƒ¨å»ºç«‹æ“šé»ï¼Œå¾Œä¾†è½‰å¾€åŒ—éƒ¨çš„åŸå› æ˜¯å› ç‚ºé­åˆ°é„­æˆåŠŸæ”»æ‰“ã€‚",
    options: ["O (æ­£ç¢º)", "X (éŒ¯èª¤)"],
    answer: "X (éŒ¯èª¤)",
    explanation: "è·è˜­äººæœ€åˆåœ¨è‡ºç£å—éƒ¨å»ºç«‹æ“šé»ï¼Œä¹‹å¾Œè½‰å¾€åŒ—éƒ¨ä¸»è¦æ˜¯ç‚ºäº†é©…é€è¥¿ç­ç‰™äººã€æ“´å¼µå‹¢åŠ›ç¯„åœã€‚"
  },
  {
    id: 26,
    category: "é„­æ°æ™‚æœŸ",
    question: "ã€æ˜¯éé¡Œã€‘æ–°åŒ—å¸‚å­”å»Ÿæ˜¯è‡ºç£ç¬¬ä¸€åº§å­”å»Ÿï¼Œä¹Ÿæ˜¯ç•¶æ™‚çš„æœ€é«˜å­¸åºœï¼Œå› æ­¤æœ‰ã€Œå…¨è‡ºé¦–å­¸ã€ä¹‹ç¨±ã€‚",
    options: ["O (æ­£ç¢º)", "X (éŒ¯èª¤)"],
    answer: "X (éŒ¯èª¤)",
    explanation: "ã€Œå…¨è‡ºé¦–å­¸ã€æ˜¯æŒ‡ã€Œè‡ºå—å­”å»Ÿã€ï¼Œä¸¦éæ–°åŒ—å¸‚å­”å»Ÿã€‚"
  },
  {
    id: 27,
    category: "é„­æ°æ™‚æœŸ",
    question: "ã€æ˜¯éé¡Œã€‘é„­æ°æ”¿æ¬Šæ™‚æœŸï¼Œé™³æ°¸è¯é‡è¦–è¾²æ¥­ç™¼å±•èˆ‡åˆ¶åº¦å»ºè¨­ï¼Œä»¥æ–‡æ²»æ–¹å¼å”åŠ©ç©©å®šè‡ºç£ç¤¾æœƒã€‚",
    options: ["O (æ­£ç¢º)", "X (éŒ¯èª¤)"],
    answer: "O (æ­£ç¢º)",
    explanation: "é™³æ°¸è¯æ˜¯é„­æ°æ”¿æ¬Šçš„é‡è¦æ–‡å®˜ï¼Œä¸»å¼µä»¥è¾²æ¥­ç‚ºåŸºç¤ï¼Œæ¨å‹•åˆ¶åº¦èˆ‡æ•™è‚²å»ºè¨­ï¼Œé€éæ–‡æ²»ç©©å®šæ°‘ç”Ÿä¸¦éå›ºæ”¿æ¬Šï¼Œè€Œéå–®ä»¥è»äº‹ä½œç‚ºæ²»ç†é‡å¿ƒã€‚"
  },
  {
    id: 28,
    category: "åŸä½æ°‘æ—",
    question: "ã€æ˜¯éé¡Œã€‘å¹³åŸ”æ—ç¾¤å¤§å¤šå±…ä½åœ¨é«˜å±±å³»å¶ºä¹‹ä¸­ï¼Œå› æ­¤å¾ˆæ™šæ‰å—åˆ°æ¼¢äººæ–‡åŒ–çš„å½±éŸ¿ã€‚",
    options: ["O (æ­£ç¢º)", "X (éŒ¯èª¤)"],
    answer: "X (éŒ¯èª¤)",
    explanation: "å¹³åŸ”æ—ç¾¤å¤šå±…ä½åœ¨ã€Œå¹³åŸã€åœ°å€ï¼Œé«˜å±±æ—ç¾¤æ‰å¤šå±…ä½åœ¨é«˜å±±æˆ–ä¸˜é™µã€‚"
  },
  {
    id: 29,
    category: "æ­·å²èˆ‡ç”Ÿæ´»",
    question: "æ­æ´²è²¿æ˜“å•†äººä¾†åˆ°è‡ºç£ï¼Œä¸»è¦æ˜¯å› ç‚ºè‡ºç£æ°£å€™å®œäººã€é©åˆå±…ä½ã€‚",
    options: ["æ­£ç¢º", "éŒ¯èª¤"],
    answer: "éŒ¯èª¤",
    explanation: "æ­æ´²è²¿æ˜“å•†äººä¾†åˆ°è‡ºç£çš„ä¸»è¦åŸå› æ˜¯è‡ºç£åœ°ç†ä½ç½®å„ªè¶Šï¼Œä½æ–¼æµ·ä¸Šè²¿æ˜“è¦é“ï¼Œé©åˆä½œç‚ºè²¿æ˜“æ“šé»ï¼Œè€Œéå› ç‚ºæ°£å€™å®œäººæˆ–é©åˆå±…ä½ã€‚"
  },
  {
    id: 30,
    category: "è·è¥¿æ™‚æœŸ",
    question: "ã€æ˜¯éé¡Œã€‘è·è˜­äººèˆ‡è¥¿ç­ç‰™äººä¾†åˆ°è‡ºç£ï¼Œæœ€ä¸»è¦çš„ç›®çš„éƒ½æ˜¯ç‚ºäº†å‚³æ’­å®—æ•™ï¼Œå…¶æ¬¡æ‰æ˜¯è²¿æ˜“ã€‚",
    options: ["O (æ­£ç¢º)", "X (éŒ¯èª¤)"],
    answer: "X (éŒ¯èª¤)",
    explanation: "è·è¥¿å…©åœ‹ä¾†è‡ºçš„ã€Œæœ€ä¸»è¦ç›®çš„ã€æ˜¯ç‚ºäº†ã€Œè²¿æ˜“ã€ç²å–åˆ©ç›Šï¼Œå‚³æ•™å¾€å¾€æ˜¯è¼”åŠ©çµ±æ²»èˆ‡æ–‡åŒ–äº¤æµçš„æ‰‹æ®µã€‚"
  },
];

// --- Firebase Initialization ---

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Main Component ---

export default function QuizGame() {
  const [user, setUser] = useState(null);
  const [gameState, setGameState] = useState('start'); // start, playing, result, leaderboard
  const [username, setUsername] = useState('');
  
  // Game Logic State
  const [questions, setQuestions] = useState([]);
  const [currentQIndex, setCurrentQIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [currentPoints, setCurrentPoints] = useState(1000); // Points for current question descending
  const [leaderboardState, setLeaderboardState] = useState({ top10: [], userEntry: null, totalCount: 0 });
  const [lastAnswerCorrect, setLastAnswerCorrect] = useState(null); // null, true, false
  const [loading, setLoading] = useState(false);
  
  // Review & Animation State
  const [wrongAnswers, setWrongAnswers] = useState([]);
  const [showReview, setShowReview] = useState(false);
  const [rankImprovement, setRankImprovement] = useState(0); // Positive number means improvement

  // Constants
  const START_POINTS = 1000;
  const POINTS_DROP_PER_SEC = 50; 
  const MIN_POINTS = 100;

  // --- Auth & Data Loading ---

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if(u) {
        // Initial fetch only to display something if needed (not strictly required for game flow)
        // But helpful if we had a "High Scores" button on start screen
      }
    });
    return () => unsubscribe();
  }, []);

  // --- Game Mechanics ---

  const startGame = () => {
    if (!username.trim()) {
      alert("è«‹è¼¸å…¥åå­—ä»¥é–‹å§‹æ¯”è³½ï¼");
      return;
    }
    
    // UPDATED: Shuffle MASTER_QUESTIONS again
    const shuffledQuestions = [...MASTER_QUESTIONS].sort(() => Math.random() - 0.5);
    
    // Shuffle options
    const questionsWithShuffledOptions = shuffledQuestions.map(q => {
      return {
        ...q,
        options: [...q.options].sort(() => Math.random() - 0.5)
      };
    });

    setQuestions(questionsWithShuffledOptions);
    setCurrentQIndex(0);
    setScore(0);
    setWrongAnswers([]); 
    setShowReview(false); 
    setRankImprovement(0);
    setGameState('playing');
    resetQuestionTimer();
  };

  const resetQuestionTimer = () => {
    setCurrentPoints(START_POINTS);
    setLastAnswerCorrect(null);
  };

  useEffect(() => {
    let timer;
    if (gameState === 'playing' && lastAnswerCorrect === null) {
      timer = setInterval(() => {
        setCurrentPoints(prev => {
          if (prev <= MIN_POINTS) return MIN_POINTS;
          return prev - POINTS_DROP_PER_SEC > MIN_POINTS ? prev - POINTS_DROP_PER_SEC : MIN_POINTS;
        });
      }, 1000);
    }
    return () => clearInterval(timer);
  }, [gameState, lastAnswerCorrect, currentQIndex]);

  const handleAnswer = (selectedOption) => {
    const currentQ = questions[currentQIndex];
    const isCorrect = selectedOption === currentQ.answer;

    if (isCorrect) {
      setScore(prev => prev + currentPoints);
      setLastAnswerCorrect(true);
    } else {
      setLastAnswerCorrect(false);
      setWrongAnswers(prev => [...prev, currentQ]);
    }

    setTimeout(() => {
      if (currentQIndex + 1 < questions.length) {
        setCurrentQIndex(prev => prev + 1);
        resetQuestionTimer();
      } else {
        finishGame(isCorrect ? score + currentPoints : score);
      }
    }, 1000); 
  };

  const finishGame = async (finalScore) => {
    setScore(finalScore);
    setGameState('result');
    await saveScore(finalScore);
  };

  // --- Firestore Operations ---

  const getAllScoresSorted = async () => {
    // RULE CHECK: "Fetch all data with simple collection() queries, then filter/sort in JavaScript memory."
    try {
      const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
      const snapshot = await getDocs(collectionRef);
      const allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // Sort in JS: Score Descending
      return allData.sort((a, b) => b.score - a.score);
    } catch (e) {
      console.error("Error fetching all scores:", e);
      return [];
    }
  };

  const saveScore = async (finalScore) => {
    if (!user) return;
    setLoading(true);
    
    // 1. Fetch CURRENT state BEFORE saving to calculate "Old Rank"
    const preSaveList = await getAllScoresSorted();
    let oldRank = null;
    const oldEntryIndex = preSaveList.findIndex(entry => entry.name === username);
    if (oldEntryIndex !== -1) {
      oldRank = oldEntryIndex + 1; // 1-based rank
    } else {
      // If user wasn't on the list, their rank was effectively "last + 1"
      oldRank = preSaveList.length + 1;
    }

    try {
      const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
      
      // 2. Check for existing user by name to update or add
      // We can use the preSaveList to find the ID without another query
      const existingEntry = preSaveList.find(entry => entry.name === username);

      if (existingEntry) {
        if (finalScore > existingEntry.score) {
           await updateDoc(doc(collectionRef, existingEntry.id), {
             score: finalScore,
             timestamp: serverTimestamp(),
             userId: user.uid 
           });
        }
      } else {
        await addDoc(collectionRef, {
          name: username,
          score: finalScore,
          timestamp: serverTimestamp(),
          userId: user.uid
        });
      }

      // 3. Fetch NEW state AFTER saving
      const postSaveList = await getAllScoresSorted();
      
      // 4. Calculate New Rank
      const newEntryIndex = postSaveList.findIndex(entry => entry.name === username);
      const newRank = newEntryIndex + 1;

      // 5. Calculate Improvement
      if (oldRank !== null) {
        const improvement = oldRank - newRank;
        if (improvement > 0) {
          setRankImprovement(improvement);
        }
      }

      // 6. Set Display Data (Top 10 + Current User if outside Top 10)
      const top10 = postSaveList.slice(0, 10);
      let userEntry = null;
      if (newRank > 10) {
        userEntry = { ...postSaveList[newEntryIndex], rank: newRank };
      }

      setLeaderboardState({
        top10: top10,
        userEntry: userEntry,
        totalCount: postSaveList.length
      });

    } catch (e) {
      console.error("Error saving score:", e);
    }
    setLoading(false);
  };

  // --- Renders ---

  const renderStartScreen = () => (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-4">
      <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl shadow-2xl w-full max-w-md border border-white/20 text-center">
        <div className="mb-6 flex justify-center">
          <div className="p-4 bg-yellow-400 rounded-full shadow-lg animate-bounce">
            <Flame size={48} className="text-red-600" />
          </div>
        </div>
        <h1 className="text-4xl font-black mb-2 tracking-wider drop-shadow-md">ç¤¾æœƒç§‘ PK è³½</h1>
        <p className="text-indigo-100 mb-8 text-lg">äº”ä¸Šå–®å…ƒ 3-4 ç¸½è¤‡ç¿’</p>
        
        <div className="space-y-4">
          <div>
            <label className="block text-left text-sm font-bold mb-2 ml-1 text-indigo-200">
              è¼¸å…¥ä½ çš„å¤§åï¼š
            </label>
            <input
              type="text"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              placeholder="ä¾‹å¦‚ï¼šäº”å¹´ä¸‰ç­ ç‹å°æ˜"
              className="w-full px-4 py-3 rounded-xl text-gray-800 font-bold focus:outline-none focus:ring-4 focus:ring-yellow-400 transition-all text-center text-lg placeholder-gray-400"
            />
          </div>
          <button
            onClick={startGame}
            className="w-full bg-yellow-400 hover:bg-yellow-300 text-red-700 font-black py-4 px-6 rounded-xl shadow-[0_4px_0_rgb(180,83,9)] active:shadow-none active:translate-y-1 transition-all text-xl flex items-center justify-center gap-2"
          >
            é–‹å§‹æŒ‘æˆ° <ArrowRight size={24} />
          </button>
        </div>
        
        <div className="mt-8 text-sm text-indigo-200 bg-black/20 p-4 rounded-lg text-left">
          <p className="font-bold mb-1">ğŸ® éŠæˆ²è¦å‰‡ï¼š</p>
          <ul className="list-disc pl-4 space-y-1">
            <li>åŒ…å«é¸æ“‡é¡Œã€æ˜¯éé¡Œèˆ‡æ™‚é–“æ’åºé¡Œã€‚</li>
            <li>æ¯é¡Œæ»¿åˆ† 1000 åˆ†ã€‚</li>
            <li><span className="text-yellow-300 font-bold">è¶Šå¿«ç­”å°åˆ†æ•¸è¶Šé«˜ï¼</span> (æ¯ç§’æ‰£50åˆ†)</li>
            <li>ç­”éŒ¯è©²é¡Œç›´æ¥ <span className="text-red-300 font-bold">0 åˆ†</span>ã€‚</li>
          </ul>
        </div>
      </div>
    </div>
  );

  const renderGameScreen = () => {
    const currentQ = questions[currentQIndex];
    return (
      <div className="flex flex-col min-h-screen bg-slate-100 font-sans">
        {/* Top Bar */}
        <div className="bg-slate-800 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-10">
          <div className="flex items-center gap-2">
            <span className="bg-slate-700 px-3 py-1 rounded-lg text-sm font-mono text-slate-300">
              Q {currentQIndex + 1} / {questions.length}
            </span>
          </div>
          <div className="flex items-center gap-3">
            <div className="flex flex-col items-end">
              <span className="text-xs text-slate-400">ç¸½åˆ†</span>
              <span className="text-2xl font-black text-yellow-400 leading-none">{score}</span>
            </div>
          </div>
        </div>

        {/* Timer Bar */}
        <div className="bg-gray-200 h-2 w-full overflow-hidden">
          <div 
            className={`h-full transition-all duration-1000 ease-linear ${
              currentPoints > 500 ? 'bg-green-500' : currentPoints > 300 ? 'bg-yellow-500' : 'bg-red-500'
            }`}
            style={{ width: `${(currentPoints / START_POINTS) * 100}%` }}
          />
        </div>

        {/* Question Area */}
        <div className="flex-1 flex flex-col items-center p-4 max-w-3xl mx-auto w-full">
          <div className="w-full bg-white rounded-2xl shadow-xl border-b-4 border-slate-200 overflow-hidden mb-6 mt-4">
            <div className="bg-indigo-600 px-4 py-2 text-white text-xs font-bold tracking-wider uppercase">
              {currentQ.category}
            </div>
            <div className="p-6 md:p-8">
              <h2 className="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed whitespace-pre-line">
                {currentQ.question}
              </h2>
            </div>
            
            {/* Score Potential Indicator */}
            <div className="bg-indigo-50 px-6 py-2 flex items-center justify-between text-indigo-700 font-bold">
              <div className="flex items-center gap-2">
                <Clock size={18} className="animate-pulse" />
                <span>æœ¬é¡Œæœ€é«˜å¯å¾—ï¼š</span>
              </div>
              <span className="text-xl">{currentPoints}</span>
            </div>
          </div>

          {/* Options Grid */}
          <div className={`grid gap-4 w-full ${currentQ.options.length === 2 ? 'grid-cols-2' : 'grid-cols-1 md:grid-cols-2'}`}>
            {currentQ.options.map((option, idx) => {
              let btnClass = "bg-white border-2 border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 text-slate-700";
              let icon = null;

              if (lastAnswerCorrect !== null) {
                if (option === currentQ.answer) {
                  btnClass = "bg-green-100 border-green-500 text-green-800 ring-2 ring-green-200";
                  icon = <CheckCircle2 size={24} className="text-green-600" />;
                } else if (lastAnswerCorrect === false && option !== currentQ.answer) {
                  btnClass = "bg-gray-100 border-transparent opacity-50";
                }
              }

              return (
                <button
                  key={idx}
                  disabled={lastAnswerCorrect !== null}
                  onClick={() => handleAnswer(option)}
                  className={`relative p-6 rounded-xl font-bold text-lg text-left transition-all shadow-sm active:scale-95 flex justify-between items-center ${btnClass}`}
                >
                  <span className="whitespace-pre-line">{option}</span>
                  {icon}
                </button>
              );
            })}
          </div>

          {/* Feedback Overlay */}
          {lastAnswerCorrect !== null && (
            <div className={`fixed inset-0 flex items-center justify-center z-50 pointer-events-none transition-opacity duration-300 ${lastAnswerCorrect ? 'bg-green-500/20' : 'bg-red-500/20'}`}>
              <div className={`transform scale-150 p-6 rounded-full shadow-2xl ${lastAnswerCorrect ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`}>
                {lastAnswerCorrect ? <CheckCircle2 size={64} /> : <XCircle size={64} />}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  const renderResultScreen = () => (
    <div className="flex flex-col items-center min-h-screen bg-slate-900 text-white p-4">
      <div className="w-full max-w-2xl bg-slate-800 rounded-3xl shadow-2xl overflow-hidden mt-8 border border-slate-700">
        <div className="bg-gradient-to-r from-purple-600 to-indigo-600 p-8 text-center relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-full opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
          <h2 className="text-3xl font-black mb-2 relative z-10">æŒ‘æˆ°å®Œæˆï¼</h2>
          <div className="text-6xl font-black text-yellow-400 drop-shadow-lg my-4 relative z-10">
            {score} <span className="text-2xl text-white">åˆ†</span>
          </div>
          <p className="text-indigo-100 relative z-10 text-lg">
            åƒè³½è€…ï¼š{username}
          </p>
        </div>

        <div className="p-6">
          <div className="flex items-center justify-between mb-6">
            <h3 className="text-xl font-bold flex items-center gap-2 text-yellow-400">
              <Trophy className="text-yellow-400" /> æ’è¡Œæ¦œ (TOP 10)
            </h3>
            {loading && <span className="text-sm text-slate-400 animate-pulse">æ›´æ–°æ’åä¸­...</span>}
          </div>

          <div className="bg-slate-900 rounded-xl overflow-hidden border border-slate-700 mb-6 relative">
            {leaderboardState.top10.length === 0 ? (
              <div className="p-8 text-center text-slate-500">
                ç›®å‰é‚„æ²’æœ‰æ’åè³‡æ–™ï¼Œä½ æ˜¯ç¬¬ä¸€å€‹å—ï¼Ÿ
              </div>
            ) : (
              <div className="divide-y divide-slate-800">
                {leaderboardState.top10.map((entry, index) => {
                  const isCurrentUser = entry.name === username;
                  const rank = index + 1;
                  
                  return (
                    <div 
                      key={entry.id || index} 
                      className={`flex items-center p-4 transition-all duration-700 ease-out relative
                        ${isCurrentUser ? 'bg-indigo-900/50 border-l-4 border-yellow-400 z-10' : 'z-0'}
                        ${rankImprovement > 0 && isCurrentUser ? 'animate-slideUpRow' : ''}
                      `}
                    >
                      <div className={`w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full font-black mr-4 relative ${
                        rank === 1 ? 'bg-yellow-400 text-yellow-900' :
                        rank === 2 ? 'bg-gray-300 text-gray-900' :
                        rank === 3 ? 'bg-orange-400 text-orange-900' :
                        'bg-slate-700 text-slate-300'
                      }`}>
                        {rank}
                      </div>
                      <div className="flex-1">
                        <div className="font-bold text-slate-200 flex items-center gap-2">
                          {entry.name}
                          {isCurrentUser && <span className="text-xs bg-indigo-500 px-2 py-0.5 rounded text-white">æˆ‘</span>}
                          
                          {/* Rank Improvement Badge */}
                          {isCurrentUser && rankImprovement > 0 && (
                            <span className="flex items-center gap-1 text-xs bg-gradient-to-r from-green-500 to-emerald-600 px-2 py-1 rounded-full text-white font-bold animate-pulse shadow-lg border border-green-300">
                              <TrendingUp size={12} /> ä¸Šå‡ {rankImprovement} å!
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="font-mono font-bold text-yellow-400 text-xl">
                        {entry.score}
                      </div>
                    </div>
                  );
                })}

                {/* Separator if user is outside top 10 */}
                {leaderboardState.userEntry && (
                   <>
                    <div className="p-2 text-center text-slate-500 text-xs tracking-widest border-t border-slate-800 bg-black/20">
                      ......
                    </div>
                    <div className={`flex items-center p-4 bg-indigo-900/30 border-l-4 border-slate-500
                      ${rankImprovement > 0 ? 'animate-slideUpRow border-yellow-400 bg-indigo-900/50' : ''}
                    `}>
                      <div className="w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full font-black mr-4 bg-slate-600 text-slate-300">
                        {leaderboardState.userEntry.rank}
                      </div>
                      <div className="flex-1">
                        <div className="font-bold text-slate-200 flex items-center gap-2">
                          {leaderboardState.userEntry.name}
                          <span className="text-xs bg-slate-500 px-2 py-0.5 rounded text-white">æˆ‘</span>
                           {/* Rank Improvement Badge (Even if outside top 10) */}
                           {rankImprovement > 0 && (
                            <span className="flex items-center gap-1 text-xs bg-gradient-to-r from-green-500 to-emerald-600 px-2 py-1 rounded-full text-white font-bold animate-pulse shadow-lg border border-green-300">
                              <TrendingUp size={12} /> ä¸Šå‡ {rankImprovement} å!
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="font-mono font-bold text-yellow-400 text-xl">
                        {leaderboardState.userEntry.score}
                      </div>
                    </div>
                   </>
                )}
              </div>
            )}
          </div>
          
          <div className="flex flex-col gap-3">
             {/* Review Wrong Answers Button */}
            <button
              onClick={() => setShowReview(!showReview)}
              className="w-full bg-indigo-500 hover:bg-indigo-400 text-white font-bold py-3 rounded-xl transition-colors flex items-center justify-center gap-2"
            >
              {showReview ? <ChevronUp /> : <BookOpen />}
              {showReview ? "æ”¶èµ·éŒ¯é¡Œè§£æ" : `æŸ¥çœ‹éŒ¯é¡Œèˆ‡è§£æ (${wrongAnswers.length}é¡Œ)`}
              {showReview ? null : <ChevronDown size={16} />}
            </button>

            {/* Wrong Answers Section */}
            {showReview && (
              <div className="bg-slate-700 rounded-xl p-4 animate-fadeIn border border-slate-600">
                {wrongAnswers.length === 0 ? (
                  <div className="text-center py-6 text-green-400 font-bold flex flex-col items-center">
                    <CheckCircle2 size={48} className="mb-2" />
                    å¤ªå²å®³äº†ï¼ä½ å…¨éƒ¨ç­”å°ï¼Œæ²’æœ‰éŒ¯é¡Œï¼
                  </div>
                ) : (
                  <div className="space-y-4">
                    {wrongAnswers.map((q, idx) => (
                      <div key={idx} className="bg-slate-800 p-4 rounded-lg border border-slate-600">
                        <div className="text-xs font-bold text-slate-400 mb-1">{q.category}</div>
                        <div className="font-bold text-white mb-2 whitespace-pre-line">{q.question}</div>
                        <div className="flex flex-col gap-2 text-sm">
                          <div className="text-green-400 font-bold flex items-start gap-2">
                            <CheckCircle2 size={16} className="mt-0.5 flex-shrink-0" />
                            <span>æ­£ç¢ºç­”æ¡ˆï¼š{q.answer}</span>
                          </div>
                          <div className="bg-indigo-900/50 p-3 rounded text-indigo-200 text-xs leading-relaxed border border-indigo-500/30">
                            <span className="font-bold text-indigo-400">è§£æï¼š</span>
                            {q.explanation}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            <button
              onClick={() => setGameState('start')}
              className="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl transition-colors"
            >
              å†æ¬¡æŒ‘æˆ° / æ›äººæŒ‘æˆ°
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="font-sans antialiased text-slate-900">
      <style>{`
        @keyframes slideUpRow {
          0% { transform: translateY(100%); opacity: 0; border-color: #fbbf24; box-shadow: 0 0 20px #fbbf24; z-index: 50; }
          100% { transform: translateY(0); opacity: 1; border-color: transparent; box-shadow: none; z-index: 0; }
        }
        .animate-slideUpRow {
          animation: slideUpRow 1s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
      `}</style>
      {gameState === 'start' && renderStartScreen()}
      {gameState === 'playing' && renderGameScreen()}
      {gameState === 'result' && renderResultScreen()}
    </div>
  );
}
